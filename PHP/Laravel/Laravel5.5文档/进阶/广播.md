# 简介

## 1、 配置
应用的所有事件广播配置选项都存放在 `config/broadcasting.php` 配置文件中。Laravel 开箱支持多种广播驱动：`Pusher`、`Redis`以及一个服务于本地开发和调试的 `log` 驱动。此外，还提供了一个 `null` 驱动用于完全禁止事件广播。每一个驱动在 `config/broadcasting.php` 配置文件中都有一个配置示例。  

## 2、 广播服务提供者
在广播任意事件之前，首先需要注册`App\Providers\BroadcastServiceProvider`。在新安装的 Laravel 应用中，你只需要取消 `config/app.php` 配置文件中 `providers` 数组内对应服务提供者之前的注释即可。该提供者允许你注册广播授权路由和回调。  

## 3、 CSRF令牌
[Laravel Echo](https://laravelacademy.org/post/8379.html#toc_17)需要访问当前 Session 的 CSRF 令牌（token），如果有效的话，Echo 将会从 JavaScript 变量`Laravel.csrfToken` 中获取令牌。如果你运行过 Artisan 命令make:auth 的话，该对象定义在 `resources/views/layouts/app.blade.php` 布局文件中。如果你没有使用这个布局，你可以在应用的 HTML 元素 `head` 中定义这样一个 `meta` 标签：  
```htm
<meta name="csrf-token" content="{{ csrf_token() }}">
```

## 4、 驱动
### \# [Pusher](https://pusher.com/)
如果你准备通过 Pusher 广播事件，需要使用 Composer 包管理器安装对应的 Pusher PHP SDK：  
```
composer require pusher/pusher-php-server "~3.0"
```
接下来，你需要在 `config/broadcasting.php` 配置文件中配置你的 Pusher 证书。一个配置好的 Pusher 示例已经包含在这个文件中，你可以按照这个模板进行修改，指定自己的 Pusher key、secret 和应用 ID 即可。`config/broadcasting.php` 文件的 `pusher` 配置还允许你指定额外的被 Pusher 支持的 `options`，例如 cluster：  
```php
'options' => [
    'cluster' => 'eu',
    'encrypted' => true
], 
```
使用 Pusher 和 Laravel Echo 的时候，需要在 `resources/assets/js/bootstrap.js` 文件中安装某个 Echo 实例的时候指定 `pusher` 作为期望的广播：  
```js
import Echo from "laravel-echo"

window.Pusher = require('pusher-js');

window.Echo = new Echo({
    broadcaster: 'pusher',
    key: 'your-pusher-key'
});
```

### \# Redis
如果你使用 Redis 广播，需要安装 Predis 库：
```
composer require predis/predis
```
Redis 广播使用 Redis 的`发布/订阅功能`进行广播；不过，你需要将其和能够接受 Redis 消息的 Websocket 服务器进行配对以便将消息广播到 Websocket 频道。  

当 Redis 广播发布事件时，事件将会被发布到指定的频道上，传递的数据是一个 JSON 格式的字符串，其中包含了事件名称、数据明细 `data`、以及生成事件socket ID 的用户。  

**Socket.IO**  
如果你想配对 Redis 广播和 Socket.IO 服务器，则需要在应用的 HTML 元素 `head` 中引入 Socket.IO JavaScript 库。当 Socket.IO 服务器启动后，会自动通过一个标准的 URL 来暴露客户端 JavaScript 库，例如，如果你在同一个域名下运行 Socket.IO 和 Web 应用，可以这样访问客户端 JavaScript 库：  
```
<script src="//{{ Request::getHost() }}:6001/socket.io/socket.io.js"></script>
```
接下来，你需要使用 socket.io 连接器和 host 来实例化 Echo：  
```js
import Echo from "laravel-echo"

window.Echo = new Echo({
    broadcaster: 'socket.io',
    host: window.location.hostname + ':6001'
});
```
最后，需要运行一个与之兼容的 Socket.IO 服务器。Laravel 并未内置一个 Socket.IO 服务器实现，不过，这里有一个第三方实现的 Socket.IO 驱动：`tlaverdure/laravel-echo-server`。  

## 5、 队列预备知识
在开始介绍广播事件之前，还需要配置并运行一个[队列监听器](https://laravelacademy.org/post/8369.html)。所有事件广播都通过队列任务来完成以便应用的响应时间不受影响。  




# 概念概览

